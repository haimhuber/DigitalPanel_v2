// 📚 תיעוד מערכת ההתראות (Alerts System Documentation)

/*
══════════════════════════════════════════════════════════════════════════════
🔔 מערכת הוספת התראות אוטומטית
══════════════════════════════════════════════════════════════════════════════

📊 מבנה הביטים במערכת (Register 12 - 15 bits):
────────────────────────────────────────────────

bits[0]  = CommStatus         -> 0 = תקלת תקשורת ⚠️
bits[1]  = ProtectionTrip     -> 1 = תקלת הגנה כללית
bits[2]  = ProtectionInstTrip -> 1 = תקלת הגנה מיידית
bits[3]  = ProtectionI_Enabled-> (מופעל/לא מופעל - לא משמש להתראות)
bits[4]  = ProtectionS_Enabled-> (מופעל/לא מופעל - לא משמש להתראות)
bits[5]  = ProtectionL_Enabled-> (מופעל/לא מופעל - לא משמש להתראות)
bits[6]  = ProtectionG_Trip   -> 1 = תקלת הגנת קרקע (Ground)
bits[7]  = ProtectionI_Trip   -> 1 = תקלת זרם יתר (Overcurrent)
bits[8]  = ProtectionS_Trip   -> 1 = תקלת קצר (Short Circuit)
bits[9]  = ProtectionL_Trip   -> 1 = תקלת עומס יתר (Overload)
bits[10] = TripDisconnected   -> 1 = מנותק
bits[11] = Tripped            -> 1 = מפסק נותק בגלל תקלה ⚠️
bits[12] = Undefined          -> לא מוגדר
bits[13] = BreakerClose       -> 1 = מפסק סגור
bits[14] = BreakerOpen        -> 1 = מפסק פתוח

══════════════════════════════════════════════════════════════════════════════
📋 חוקי יצירת התראות
══════════════════════════════════════════════════════════════════════════════

1️⃣ תקלת תקשורת (Communication Error):
   ────────────────────────────────────
   תנאי: CommStatus = 0 (ביט 0)
   סוג התראה: "CommStatus - Error"
   הודעה: "תקלת תקשורת במתג X"
   ⚠️ שים לב: 0 = תקלה, 1 = תקין

2️⃣ מפסק נותק (Tripped):
   ─────────────────────
   תנאי: Tripped = 1 (ביט 11)
   סוג התראה: "Tripped"
   הודעה: "המפסק X נותק בגלל תקלה"

3️⃣ תקלת הגנה כללית (Protection Trip):
   ──────────────────────────────────
   תנאי: ProtectionTrip = 1 (ביט 1)
   סוג התראה: "ProtectionTrip"
   הודעה: "תקלת הגנה במתג X"

4️⃣ תקלת זרם יתר (Overcurrent):
   ────────────────────────────
   תנאי: ProtectionI_Trip = 1 (ביט 7)
   סוג התראה: "ProtectionI_Trip"
   הודעה: "תקלת זרם יתר במתג X"

5️⃣ תקלת קצר (Short Circuit):
   ───────────────────────────
   תנאי: ProtectionS_Trip = 1 (ביט 8)
   סוג התראה: "ProtectionS_Trip"
   הודעה: "תקלת קצר במתג X"

6️⃣ תקלת עומס יתר (Overload):
   ───────────────────────────
   תנאי: ProtectionL_Trip = 1 (ביט 9)
   סוג התראה: "ProtectionL_Trip"
   הודעה: "תקלת עומס יתר במתג X"

7️⃣ תקלת הגנת קרקע (Ground Fault):
   ─────────────────────────────────
   תנאי: ProtectionG_Trip = 1 (ביט 6)
   סוג התראה: "ProtectionG_Trip"
   הודעה: "תקלת הגנת קרקע במתג X"

══════════════════════════════════════════════════════════════════════════════
🔄 תהליך יצירת התראה
══════════════════════════════════════════════════════════════════════════════

1. הנתונים מגיעים מה-Modbus (כל 5 שניות)
2. הפונקציה writeBreakerData מפענחת את הביטים
3. הפונקציה checkAndAddAlerts בודקת כל ביט
4. אם יש תקלה - קוראת ל-SP AddProtectionAlert
5. ה-SP בודק אם כבר קיימת התראה כזו (לא מאושרת)
6. אם לא קיימת - מוסיפה התראה חדשה לטבלת Alerts

══════════════════════════════════════════════════════════════════════════════
💾 Stored Procedure: AddProtectionAlert
══════════════════════════════════════════════════════════════════════════════

Parameters:
  @switch_id INT           - מספר המתג (1, 2, 3...)
  @alert_type VARCHAR(50)  - סוג התקלה
  @alert_message VARCHAR(255) - הודעה מפורטת

Logic:
  1. בודק אם כבר קיימת התראה זהה שעדיין לא אושרה (alertAck = 0)
  2. אם לא קיימת - מוסיף התראה חדשה
  3. אם כבר קיימת - לא מוסיף כפילות

דוגמאות שימוש:
  EXEC AddProtectionAlert 
    @switch_id = 1, 
    @alert_type = 'CommStatus - Error', 
    @alert_message = 'תקלת תקשורת במתג 1'

  EXEC AddProtectionAlert 
    @switch_id = 2, 
    @alert_type = 'Tripped', 
    @alert_message = 'המפסק 2 נותק בגלל תקלה'

══════════════════════════════════════════════════════════════════════════════
📊 מבנה טבלת Alerts
══════════════════════════════════════════════════════════════════════════════

id              INT              - מזהה ייחודי
alarmId         INT              - מספר המתג
alarmType       VARCHAR(50)      - סוג ההתראה
alarmMessage    VARCHAR(MAX)     - הודעת ההתראה
timestamp       DATETIME         - זמן יצירת ההתראה
alertAck        BIT              - האם אושרה? (0 = לא, 1 = כן)

══════════════════════════════════════════════════════════════════════════════
🎯 סיכום
══════════════════════════════════════════════════════════════════════════════

✅ תקלת תקשורת: CommStatus = 0
✅ כל תקלות ה-TRIP: הביט = 1
✅ מערכת מונעת כפילויות של התראות
✅ התראות מתווספות אוטומטית בזמן אמת
✅ ניתן לאשר התראות דרך UpdateAlertAck

*/
